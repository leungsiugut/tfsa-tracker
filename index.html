<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TFSA Tracker</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #fff8dc; /* 鵝黃色 */
    color: #1e3a8a; /* 藍色 */
    max-width: 960px;
    margin: auto;
    padding: 20px;
  }
  h1 { text-align: center; color: #1e3a8a; }
  #login-btn {
    display: block;
    margin: 30px auto;
    padding: 12px 25px;
    font-size: 18px;
    background: #1e3a8a;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  form {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 8px rgb(30 58 138 / 0.3);
    margin-bottom: 25px;
  }
  input, select, button {
    font-size: 1rem;
    padding: 8px 10px;
    margin: 5px;
    border-radius: 6px;
    border: 1px solid #1e3a8a;
    color: #1e3a8a;
  }
  button {
    background: #1e3a8a;
    color: white;
    border: none;
    cursor: pointer;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
  }
  th, td {
    border-bottom: 1px solid #1e3a8a;
    padding: 10px;
    text-align: left;
  }
  th {
    background: #cbd5e1;
    color: #1e3a8a;
  }
  .action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: #1e3a8a;
    font-size: 18px;
    margin: 0 3px;
  }
  #container {
    display: flex;
    gap: 20px;
  }
  #balances-section {
    width: 30%;
  }
  #transactions-section {
    width: 70%;
  }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>TFSA Tracker</h1>

<button id="login-btn" style="display:none;">用Google帳戶登入</button>

<div id="app" style="display:none;">
  <p><strong>Current Contribution Room: </strong><span id="room">0</span></p>

  <div id="container">
    <section id="balances-section">
      <h2>Account Balances</h2>
      <table>
        <thead>
          <tr><th>Bank Account</th><th>Balance</th></tr>
        </thead>
        <tbody id="balances"></tbody>
      </table>
    </section>

    <section id="transactions-section">
      <h2>Transactions</h2>
      <form id="tfsa-form">
        <input type="date" id="date" required />
        <select id="action" required>
          <option value="Contribution">Contribution</option>
          <option value="Withdraw">Withdraw</option>
          <option value="Interest">Interest</option>
          <option value="Transfer">Transfer</option>
          <option value="Room Increase">Room Increase</option>
        </select>
        <input type="text" id="bankAccount" placeholder="Bank Account" />
        <input type="number" step="0.01" id="amount" placeholder="Amount $" required />
        <button type="submit">Add</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Transaction Type</th>
            <th>From Bank Account</th>
            <th>To Bank Account</th>
            <th>Amount</th>
            <th>Contribution Room After</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="log"></tbody>
      </table>
    </section>
  </div>

<script>
  // YOUR CLIENT_ID here
  const CLIENT_ID = "255642706987-fm46aujhnbk3ffoqg2cukm59j2de9hjm.apps.googleusercontent.com";
  const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  let accessToken = null;
  let userId = null;

  const loginBtn = document.getElementById("login-btn");
  const appDiv = document.getElementById("app");

  let transactions = [];
  let contributionRoom = 0;

  function commaFormat(num) {
    return num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function formatMoney(num) {
    return "$" + commaFormat(num);
  }

  function updateUI() {
    // Sort transactions by date and input order
    transactions.sort((a, b) => {
      if (a.date < b.date) return -1;
      if (a.date > b.date) return 1;
      return 0;
    });

    contributionRoom = 0;
    let balances = {};

    transactions.forEach((tx) => {
      // Calculate balances and contribution room
      if (tx.action === "Contribution") contributionRoom -= tx.amount;
      else if (tx.action === "Withdraw") contributionRoom += tx.amount;
      else if (tx.action === "Room Increase") contributionRoom += tx.amount;

      if (tx.action === "Transfer") {
        // Transfer: bankAccount format: "From→To" or "From → To"
        const parts = tx.bankAccount.split("→").map(s => s.trim());
        if (parts.length === 2) {
          balances[parts[0]] = (balances[parts[0]] || 0) - tx.amount;
          balances[parts[1]] = (balances[parts[1]] || 0) + tx.amount;
        }
      } else {
        balances[tx.bankAccount] = (balances[tx.bankAccount] || 0) + (tx.action === "Withdraw" ? -tx.amount : tx.amount);
      }
    });

    document.getElementById("room").textContent = commaFormat(contributionRoom);

    // Render balances
    const balancesBody = document.getElementById("balances");
    balancesBody.innerHTML = "";
    for (const ba in balances) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ba}</td><td>${formatMoney(balances[ba])}</td>`;
      balancesBody.appendChild(tr);
    }

    // Render transactions log
    const logBody = document.getElementById("log");
    logBody.innerHTML = "";
    transactions.forEach((tx, idx) => {
      const tr = document.createElement("tr");

      // From and To Bank Account columns
      let fromBA = "";
      let toBA = tx.bankAccount;
      if (tx.action === "Transfer") {
        const parts = tx.bankAccount.split("→").map(s => s.trim());
        fromBA = parts[0] || "";
        toBA = parts[1] || "";
      } else if (tx.action === "Room Increase") {
        toBA = "";
      }

      tr.innerHTML = `
        <td>${tx.date}</td>
        <td>${tx.action}</td>
        <td>${fromBA}</td>
        <td>${toBA}</td>
        <td>${formatMoney(tx.amount)}</td>
        <td>${formatMoney(contributionRoom)}</td>
        <td>
          <button class="action-btn" title="Edit" onclick="editTx(${idx})">&#9998;</button>
          <button class="action-btn" title="Delete" onclick="deleteTx(${idx})">&#128465;</button>
        </td>
      `;
      logBody.appendChild(tr);
    });
  }

  function saveToDrive() {
    if (!accessToken || !userId) return Promise.reject("No login");
    const fileName = `tfsa_tracker_${userId}.json`;
    const content = JSON.stringify({transactions});
    const metadata = {
      name: fileName,
      parents: ['appDataFolder'],
      mimeType: 'application/json'
    };

    // First list files with this name
    return gapi.client.drive.files.list({
      spaces: 'appDataFolder',
      fields: 'files(id, name)',
      q: `name='${fileName}'`
    }).then(response => {
      const files = response.result.files;
      if (files && files.length > 0) {
        // update existing
        const fileId = files[0].id;
        return gapi.client.drive.files.update({
          fileId: fileId,
          media: {
            mimeType: 'application/json',
            body: content
          }
        });
      } else {
        // create new
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', new Blob([content], {type: 'application/json'}));

        // Use fetch for multipart upload (gapi has issues with multipart upload)
        return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + accessToken },
          body: form
        });
      }
    });
  }

  function loadFromDrive() {
    if (!accessToken || !userId) return Promise.reject("No login");
    const fileName = `tfsa_tracker_${userId}.json`;

    return gapi.client.drive.files.list({
      spaces: 'appDataFolder',
      fields: 'files(id, name)',
      q: `name='${fileName}'`
    }).then(response => {
      const files = response.result.files;
      if (files && files.length > 0) {
        const fileId = files[0].id;
        return gapi.client.drive.files.get({
          fileId: fileId,
          alt: 'media'
        });
      } else {
        return Promise.reject("No backup file");
      }
    }).then(fileContent => {
      const data = JSON.parse(fileContent.body || fileContent);
      transactions = data.transactions || [];
      updateUI();
    });
  }

  function initGapi() {
    gapi.load('client', async () => {
      await gapi.client.init({
        apiKey: '', // no apiKey needed for appDataFolder
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
      });
      gapiInited = true;
      maybeEnableButtons();
    });
  }

  function maybeEnableButtons() {
    if (gisInited && gapiInited) {
      loginBtn.style.display = 'block';
    }
  }

  function handleCredentialResponse(response) {
    accessToken = response.access_token;
    // decode id_token for user sub
    const base64Url = response.id_token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    userId = JSON.parse(jsonPayload).sub;

    loginBtn.style.display = 'none';
    appDiv.style.display = 'block';

    loadFromDrive().catch(() => {
      // no backup found, start fresh
      transactions = [];
      updateUI();
    });
  }

  function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: handleCredentialResponse,
    });
    gisInited = true;
    maybeEnableButtons();
  }

  loginBtn.addEventListener('click', () => {
    tokenClient.requestAccessToken();
  });

  // Form submit add new transaction
  document.getElementById('tfsa-form').addEventListener('submit', e => {
    e.preventDefault();
    const date = document.getElementById('date').value;
    const action = document.getElementById('action').value;
    const bankAccount = document.getElementById('bankAccount').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    if (!date || !action || (action !== "Room Increase" && !bankAccount) || isNaN(amount)) {
      alert('請填寫完整資料');
      return;
    }
    transactions.push({date, action, bankAccount, amount});
    updateUI();
    saveToDrive().catch(e => alert('儲存失敗: '+e.message || e));
    e.target.reset();
  });

  window.editTx = function(idx) {
    const tx = transactions[idx];
    document.getElementById('date').value = tx.date;
    document.getElementById('action').value = tx.action;
    document.getElementById('bankAccount').value = tx.bankAccount;
    document.getElementById('amount').value = tx.amount;
    // delete old entry while editing (simple approach)
    transactions.splice(idx,1);
    updateUI();
  }

  window.deleteTx = function(idx) {
    if (confirm('確定刪除該交易嗎？')) {
      transactions.splice(idx,1);
      updateUI();
      saveToDrive().catch(e => alert('儲存失敗: '+e.message || e));
    }
  }

  window.onload = () => {
    initGapi();
    initializeGis();
  };
</script>

</body>
</html>

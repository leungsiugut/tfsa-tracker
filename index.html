<!DOCTYPE html>
<html>
<head>
  <title>TFSA Tracker</title>
  <meta name="google-signin-client_id" content="255642706987-fm46aujhnbk3ffoqg2cukm59j2de9hjm.apps.googleusercontent.com">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffdf0;
      color: #333;
      max-width: 960px;
      margin: auto;
      padding: 30px;
    }
    h1 {
      color: #1c4e80;
    }
    form {
      background: #fff8d4;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #1c4e80;
      color: white;
      border: none;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    th, td {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #ffe;
      font-weight: bold;
    }
    .section-title {
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 1.3em;
    }
    .hidden { display: none; }
    .action-btn { margin-left: 10px; color: #1c4e80; cursor: pointer; }
  </style>
</head>
<body>
  <h1>TFSA Tracker</h1>
  <div id="signin-button"></div>
  <p id="user-email"></p>
  <p><strong>Current Contribution Room:</strong> <span id="room">0</span></p>

  <form id="tfsa-form" class="hidden">
    <input type="date" id="date" required>
    <select id="action">
      <option value="Contribution">Contribution</option>
      <option value="Withdraw">Withdraw</option>
      <option value="Interest">Interest</option>
      <option value="Transfer">Transfer</option>
      <option value="Room Increase">Room Increase</option>
    </select>
    <input type="text" id="bankAccount" placeholder="Bank Account" required>
    <input type="number" step="0.01" id="amount" placeholder="Amount $" required>
    <button type="submit">Add Transaction</button>
  </form>

  <div id="main" class="hidden">
    <div class="section-title">Transactions</div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Action</th><th>Bank Account</th><th>Amount</th><th>Contribution Room After</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="log"></tbody>
    </table>

    <div class="section-title">Account Balances</div>
    <table>
      <thead>
        <tr><th>Bank</th><th>Account</th><th>Balance</th></tr>
      </thead>
      <tbody id="balances"></tbody>
    </table>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    let tokenClient, accessToken, userEmail = "", userId = "";
    let transactions = [], balances = {}, contributionRoom = 0;
    const fileName = () => `tfsa_tracker_${userId}.json`;

    const roomDisplay = document.getElementById("room");
    const log = document.getElementById("log");
    const balancesTable = document.getElementById("balances");

    function updateUI() {
      log.innerHTML = "";
      balances = {}; contributionRoom = 0;
      transactions.forEach((tx, i) => {
        const key = tx.bankAccount;
        if (!balances[key]) balances[key] = 0;
        const amount = tx.amount;
        if (tx.action === "Contribution") { balances[key] += amount; contributionRoom -= amount; }
        else if (tx.action === "Withdraw") { balances[key] -= amount; contributionRoom += amount; }
        else if (tx.action === "Interest") { balances[key] += amount; }
        else if (tx.action === "Room Increase") { contributionRoom += amount; }
        else if (tx.action === "Transfer") {
          const parts = tx.bankAccount.split("â†’");
          if (parts.length === 2) {
            const from = parts[0].trim(), to = parts[1].trim();
            balances[from] = (balances[from] || 0) - amount;
            balances[to] = (balances[to] || 0) + amount;
          }
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${tx.date}</td>
          <td>${tx.action}</td>
          <td>${tx.bankAccount}</td>
          <td>$${amount.toFixed(2)}</td>
          <td>${contributionRoom.toLocaleString()}</td>
          <td>
            <span class="action-btn" onclick="editTx(${i})">Edit</span>
            <span class="action-btn" onclick="deleteTx(${i})">Delete</span>
          </td>
        `;
        log.appendChild(row);
      });
      roomDisplay.textContent = contributionRoom.toLocaleString();
      balancesTable.innerHTML = "";
      for (const key in balances) {
        const [bank, account] = key.split("|");
        const row = document.createElement("tr");
        row.innerHTML = `<td>${bank}</td><td>${account}</td><td>$${balances[key].toFixed(2)}</td>`;
        balancesTable.appendChild(row);
      }
    }

    async function loadData() {
      const resp = await gapi.client.drive.files.list({
        spaces: 'appDataFolder', fields: 'files(id,name)', q: `name='${fileName()}'`
      });
      if (resp.result.files.length) {
        const fileId = resp.result.files[0].id;
        const content = await gapi.client.drive.files.get({ fileId, alt: 'media' });
        transactions = JSON.parse(content.body);
        updateUI();
      } else {
        transactions = [];
        updateUI();
        document.getElementById("tfsa-form").classList.remove("hidden");
      }
    }

    async function saveData() {
      const blob = new Blob([JSON.stringify(transactions)], { type: 'application/json' });
      const fileMeta = { name: fileName(), parents: ['appDataFolder'] };

      const list = await gapi.client.drive.files.list({ spaces: 'appDataFolder', q: `name='${fileName()}'`, fields: 'files(id)' });
      const existing = list.result.files[0];

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMeta)], { type: 'application/json' }));
      form.append('file', blob);

      const method = existing ? 'PATCH' : 'POST';
      const url = existing ?
        `https://www.googleapis.com/upload/drive/v3/files/${existing.id}?uploadType=multipart` :
        `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;

      await fetch(url, {
        method,
        headers: new Headers({ Authorization: `Bearer ${accessToken}` }),
        body: form
      });
    }

    function editTx(index) {
      const tx = transactions[index];
      document.getElementById("date").value = tx.date;
      document.getElementById("action").value = tx.action;
      document.getElementById("bankAccount").value = tx.bankAccount;
      document.getElementById("amount").value = tx.amount;
      transactions.splice(index, 1);
      updateUI();
    }

    function deleteTx(index) {
      transactions.splice(index, 1);
      updateUI();
      saveData();
    }

    document.getElementById("tfsa-form").addEventListener("submit", e => {
      e.preventDefault();
      transactions.push({
        date: document.getElementById("date").value,
        action: document.getElementById("action").value,
        bankAccount: document.getElementById("bankAccount").value,
        amount: parseFloat(document.getElementById("amount").value)
      });
      updateUI();
      saveData();
      e.target.reset();
    });

    window.onload = () => {
      google.accounts.id.initialize({
        client_id: "255642706987-fm46aujhnbk3ffoqg2cukm59j2de9hjm.apps.googleusercontent.com",
        callback: async (res) => {
          const credential = res.credential;
          const response = await fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=" + credential);
          const data = await response.json();
          userEmail = data.email;
          userId = data.sub;
          document.getElementById("signin-button").classList.add("hidden");
          document.getElementById("user-email").textContent = `Logged in as ${userEmail}`;
          document.getElementById("main").classList.remove("hidden");
          document.getElementById("tfsa-form").classList.remove("hidden");

          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: "255642706987-fm46aujhnbk3ffoqg2cukm59j2de9hjm.apps.googleusercontent.com",
            scope: "https://www.googleapis.com/auth/drive.appdata",
            callback: async (res) => {
              accessToken = res.access_token;
              gapi.load('client', async () => {
                await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
                gapi.client.setToken({ access_token: accessToken });
                await loadData();
              });
            }
          });
          tokenClient.requestAccessToken();
        }
      });
      google.accounts.id.renderButton(document.getElementById("signin-button"), {
        theme: "filled_blue", size: "large"
      });
    };
  </script>
</body>
</html>
